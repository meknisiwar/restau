{% extends 'base.html.twig' %}

{% block title %}{{ product.name }}{% endblock %}

{% block body %}
<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ path('app_product_index') }}">Products</a></li>
            <li class="breadcrumb-item active">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-6">
            {% set fallback = asset('images/food_bg.jpg') %}

            <div class="product-gallery">
                {% set mainImage = product.image ?: fallback %}
                <a href="{{ mainImage }}" class="glightbox" data-gallery="product-gallery">
                    <img src="{{ mainImage }}" loading="lazy" class="img-fluid rounded main-product-image" alt="{{ product.name }}" onerror="this.onerror=null;this.src='{{ fallback }}';">
                </a>

                <div class="product-thumbs mt-3 d-flex gap-2">
                    {# main thumbnail #}
                    <a href="{{ mainImage }}" class="glightbox" data-gallery="product-gallery">
                        <img src="{{ mainImage }}" class="thumb-img rounded" alt="{{ product.name }}">
                    </a>

                    {# sample: try related images or fallback variations #}
                    {% for i in 1..3 %}
                        {% set tryImg = product.image ?: asset('images/food_bg.jpg') %}
                        <a href="{{ tryImg }}" class="glightbox" data-gallery="product-gallery">
                            <img src="{{ tryImg }}" class="thumb-img rounded" alt="{{ product.name }}">
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <h1>{{ product.name }}</h1>
            
            {% if product.category %}
            <p class="text-muted">
                <i class="bi bi-tag"></i> 
                <a href="{{ path('app_product_index', {category: product.category.id}) }}">
                    {{ product.category.name }}
                </a>
            </p>
            {% endif %}

            <h3 class="text-success mb-3">{{ product.price }}DT</h3>

            {% if not product.available %}
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> This product is currently out of stock
            </div>
            {% endif %}

            <p class="lead">{{ product.description }}</p>

            <div class="mb-3">
                <h6>Ingredients</h6>
                <p class="small text-muted">{% if product.description %}{{ product.description|slice(0,200) }}{% else %}Ingredients not available{% endif %}</p>
            </div>

            {% if product.available and is_granted('ROLE_USER') %}
            <form method="post" action="{{ path('app_cart_add', {id: product.id}) }}" class="mt-4 d-flex gap-2 align-items-center">
                <div>
                    <label for="quantity" class="form-label mb-1">Quantity</label>
                    <input type="number" name="quantity" id="quantity" value="1" min="1" max="99" class="form-control" style="width: 100px;">
                </div>
                <div style="flex:1">
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-cart-plus"></i> Add to Cart
                    </button>
                </div>
            </form>
            {% elseif not is_granted('ROLE_USER') %}
            <div class="alert alert-info mt-4">
                <i class="bi bi-info-circle"></i> Please <a href="{{ path('app_login') }}">login</a> to add items to your cart
            </div>
            {% endif %}

            {# Related products preview #}
            <div class="mt-4">
                <h6>Related</h6>
                <div class="d-flex gap-2">
                    {% for rel in product.category and product.category.products|slice(0,4) ?: [] %}
                        {% if rel.id != product.id %}
                        <a href="{{ path('app_product_show',{id:rel.id}) }}" class="card p-2 text-decoration-none text-dark" style="width:120px;">
                            <img src="{{ rel.image ?: asset('images/food_bg.jpg') }}" style="height:70px;object-fit:cover;" class="w-100 rounded mb-1" alt="{{ rel.name }}">
                            <div class="small">{{ rel.name }}</div>
                        </a>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {# Reviews section #}
    <div class="row mt-5">
        <div class="col-md-8">
            <h4>Customer reviews</h4>

            {# Average rating display #}
            {% set reviews = product.reviews|default([]) %}
            {% set avg = (reviews|length) > 0 ? (reviews|map(r => r.getRating())|reduce((carry, item) => carry + item, 0) / (reviews|length)) : 0 %}

            <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                    {% for i in 1..5 %}
                        <i class="bi bi-star-fill" style="color: {{ i <= avg ? 'var(--primary)' : 'rgba(255,255,255,0.12)' }}"></i>
                    {% endfor %}
                </div>
                <div class="small text-muted">{{ reviews|length }} review(s) â€¢ Average {{ avg|round(1) }}</div>
            </div>

            {# List of reviews #}
            <div class="list-group">
                {% for r in reviews %}
                <div class="list-group-item bg-transparent border-0 p-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>{{ r.getUser() ? r.getUser().getEmail() : 'Anonymous' }}</strong>
                            <div class="small text-muted">{{ r.getCreatedAt() ? r.getCreatedAt().format('Y-m-d') : '' }}</div>
                        </div>
                        <div>
                            {% for i in 1..5 %}
                                <i class="bi bi-star-fill" style="color: {{ i <= r.getRating() ? 'var(--primary)' : 'rgba(255,255,255,0.12)' }}"></i>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mt-2 small">{{ r.getComment() }}</div>
                </div>
                <hr class="border-secondary">
                {% else %}
                <div class="small text-muted">Be the first to leave a review for this product.</div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-4">
            <h5>Leave a review</h5>

            {% if is_granted('ROLE_USER') %}
            <form method="post" action="{{ path('app_review_product', {id: product.id}) }}">
                <div class="mb-3">
                    <label for="rating" class="form-label">Rating</label>
                    <select id="rating" name="rating" class="form-select form-select-sm">
                        <option value="5">5 - Excellent</option>
                        <option value="4">4 - Very good</option>
                        <option value="3">3 - Good</option>
                        <option value="2">2 - Fair</option>
                        <option value="1">1 - Poor</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="comment" class="form-label">Comment</label>
                    <textarea id="comment" name="comment" rows="4" class="form-control" placeholder="Share your experience (min 2 characters)"></textarea>
                </div>
                <button class="btn btn-primary w-100" type="submit">Submit review</button>
            </form>
            {% else %}
            <div class="alert alert-info">Please <a href="{{ path('app_login') }}">login</a> to leave a review.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            if (typeof GLightbox !== 'undefined') {
                GLightbox({ selector: '.glightbox' });
            }
        });
    </script>
{% endblock %}

